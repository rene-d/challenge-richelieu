#! /bin/bash

# étape 1
curl -s -O https://www.challengecybersec.fr/Richelieu.pdf

# étape 2
pdftotext Richelieu.pdf Richelieu.txt

# étape 3
sed '1,8d;/^$/d;s/\x0c//' Richelieu.txt | base64 -d > data

# étape 4
PASSPHRASE1=$(unzip -l data 2>/dev/null | sed 's/est : \(.*\)/\1/p;d')
unzip -o -P "${PASSPHRASE1}" data

# étape 5
python3 $(dirname $0)/findkey.py
openssl rsautl -decrypt -inkey priv.key -in motDePasseGPG.txt.enc -out motDePasseGPG.txt

# étape 6
PASSPHRASE2=$(cat motDePasseGPG.txt)
gpg --batch --passphrase "${PASSPHRASE2}" --yes  --output lsb_RGB.png --decrypt lsb_RGB.png.enc

# étape 7
zsteg --extract b1,rgb,lsb,yx lsb_RGB.png > extract.hex
cat extract.hex | tr -cd '[:print:]\n' | grep "^00......: " | xxd -r > prog.bin

# étape 8
sed -i 's/ALD/UPX/g' prog.bin
upx -d prog.bin
chmod a+x prog.bin

# étape 9
PASSPHRASE3='DGSE{g456@g5112bgyfMnbVXw.llM}'
unzip -o -P "${PASSPHRASE3}" suite.zip
