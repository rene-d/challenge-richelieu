#! /usr/bin/env bash

m()
{
    echo -e "\033[32m$@\033[0m"
}

# étape 1
m "étape 1: téléchargement du PDF"
# curl -s -O https://www.challengecybersec.fr/Richelieu.pdf
cp $(dirname $0)/Richelieu.pdf .

# étape 2
m "étape 2: extraction du texte"
pdftotext Richelieu.pdf Richelieu.txt

# étape 3
m "étape 3: extraction Base64"
sed '1,8d;/^$/d;s/\x0c//' Richelieu.txt | base64 -d > data

# étape 4
m "étape 4: unzip archive après JPEG"
PASSPHRASE1=$(unzip -l data 2>/dev/null | sed 's/est : \(.*\)/\1/p;d')
unzip -o -P "${PASSPHRASE1}" data

# étape 5
m "étape 5: recherche clé privée RSA"
python3 $(dirname $0)/findkey.py
openssl rsautl -decrypt -inkey priv.key -in motDePasseGPG.txt.enc -out motDePasseGPG.txt

# étape 6
m "étape 6: décryptage PNG"
PASSPHRASE2=$(cat motDePasseGPG.txt)
gpg --batch --passphrase "${PASSPHRASE2}" --yes  --output lsb_RGB.png --decrypt lsb_RGB.png.enc

# étape 7
m "étape 7: stéganographie"
python3 $(dirname $0)/lsb_rgb.py

# étape 8
m "étape 8: décompression UPX"
sed -i 's/ALD/UPX/g' prog.bin
upx -d prog.bin
chmod a+x prog.bin

# étape 9
m "étape 9: extraction de la suite"
PASSPHRASE3='DGSE{g456@g5112bgyfMnbVXw.llM}'
unzip -o -P "${PASSPHRASE3}" suite.zip
cat suite.txt
